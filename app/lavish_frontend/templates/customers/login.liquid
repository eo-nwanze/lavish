{{ 'customer.css' | asset_url | stylesheet_tag }}
{{ 'enhanced-account.css' | asset_url | stylesheet_tag }}

<script>
  // Detect if we're running locally and provide alternative login
  document.addEventListener('DOMContentLoaded', function() {
    const isLocalhost = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.location.port === '9292';
    
    if (isLocalhost) {
      console.log('Running locally - providing alternative login method');
      
      // Check if we have the Customer Account API error
      const urlParams = new URLSearchParams(window.location.search);
      const hasError = window.location.search.includes('authentication/') || 
                      window.location.search.includes('verify') ||
                      window.location.pathname.includes('authentication/');
      
      if (hasError) {
        console.log('Customer Account API error detected, redirecting to dev mode');
        // Redirect to the same page with dev_mode parameter
        window.location.href = '/account/login?dev_mode=1';
        return;
      }
      
      // Show local development notice if not in dev mode
      if (!urlParams.has('dev_mode')) {
        const loginForm = document.querySelector('form[action*="login"]');
        if (loginForm) {
          const notice = document.createElement('div');
          notice.className = 'local-dev-notice';
          notice.innerHTML = `
            <div class="notice-content">
              <h3>ðŸ”§ Local Development Mode</h3>
              <p>Shopify Customer Account API is not available in local development.</p>
              <p>Please use one of these options:</p>
              <ul>
                <li><strong>Option 1:</strong> <a href="/account/login?dev_mode=1" target="_self">Use Development Login</a></li>
                <li><strong>Option 2:</strong> Disable Customer Account API in Shopify Admin</li>
                <li><strong>Option 3:</strong> Test on the live theme preview</li>
              </ul>
              <button onclick="this.parentElement.parentElement.style.display='none'" class="close-notice">Continue Anyway</button>
            </div>
          `;
          loginForm.parentElement.insertBefore(notice, loginForm);
        }
      }
    }
  });
</script>

<style>
  .local-dev-notice {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  }
  
  .notice-content h3 {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
  }
  
  .notice-content p {
    margin: 0.5rem 0;
    opacity: 0.9;
  }
  
  .notice-content ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }
  
  .notice-content li {
    margin: 0.5rem 0;
  }
  
  .notice-content a {
    color: #ffd700;
    text-decoration: none;
    font-weight: bold;
  }
  
  .notice-content a:hover {
    text-decoration: underline;
  }
  
  .close-notice {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 1rem;
    transition: all 0.3s ease;
  }
  
  .close-notice:hover {
    background: rgba(255,255,255,0.3);
  }
</style>

<div class="customer account section-{{ section.id }}-padding">
  <div class="page-width">
    <div class="grid">
      <div class="grid__item medium-up--one-half medium-up--push-one-quarter">
        <header class="customer__header">
          <h1 class="customer__title">Log in</h1>
        </header>

        <div class="form-vertical">
          <!-- Local Development Bypass -->
          {% assign url_params = request.url_params %}
          {% if url_params contains 'dev_mode=1' %}
            <div class="local-dev-bypass">
              <h3>ðŸ”§ Local Development Login</h3>
              <p>This is a bypass for local development when Customer Account API is enabled.</p>
              <div class="bypass-form">
                <input type="email" id="devEmail" placeholder="Enter your email for testing" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="devLogin()" class="button" style="width: 100%; padding: 0.75rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  Simulate Login (Local Dev)
                </button>
              </div>
              <p><small>This will simulate a login for local development purposes.</small></p>
            </div>
            
            <script>
              function devLogin() {
                const email = document.getElementById('devEmail').value;
                if (!email) {
                  alert('Please enter an email address');
                  return;
                }
                
                // Simulate successful login by redirecting to account page
                // In real scenario, this would authenticate with Shopify
                console.log('Simulating login for:', email);
                
                // Show success message
                const bypassDiv = document.querySelector('.local-dev-bypass');
                bypassDiv.innerHTML = `
                  <div style="text-align: center; padding: 2rem; background: #d4edda; border-radius: 8px; color: #155724;">
                    <h3>âœ… Login Simulated Successfully</h3>
                    <p>Welcome back! (Local Development Mode)</p>
                    <p><strong>Email:</strong> ${email}</p>
                    <p><strong>Customer ID:</strong> DEV_${Date.now()}</p>
                    <button onclick="window.location.href='/account'" class="button" style="margin-top: 1rem;">Go to Account</button>
                  </div>
                `;
              }
            </script>
            
            <style>
              .local-dev-bypass {
                background: #f8f9fa;
                border: 2px dashed #007bff;
                padding: 2rem;
                border-radius: 8px;
                margin-bottom: 2rem;
                text-align: center;
              }
              .local-dev-bypass h3 {
                color: #007bff;
                margin-bottom: 1rem;
              }
            </style>
          {% endif %}
          
          {%- form 'customer_login', novalidate: 'novalidate' -%}
            {%- if form.errors -%}
              <div class="form-message form-message--error">
                <h2 class="h3 form-message__title" tabindex="-1" data-form-status>
                  Please adjust the following:
                </h2>
                <ul class="form-message__list">
                  {%- for field in form.errors -%}
                    <li>
                      {%- if field == 'form' -%}
                        {{ form.errors.messages[field] }}
                      {%- else -%}
                        <a href="#RegisterForm-{{ field }}">
                          {{ form.errors.translated_fields[field] | capitalize }}
                          {{ form.errors.messages[field] }}
                        </a>
                      {%- endif -%}
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
            {%- endif -%}

            <div class="form__input-wrapper">
              <label for="CustomerEmail">Email</label>
              <input
                type="email"
                name="customer[email]"
                id="CustomerEmail"
                autocomplete="email"
                autocorrect="off"
                autocapitalize="off"
                {% if form.errors contains 'form' %}
                  aria-invalid="true"
                  aria-describedby="LoginForm-error-email"
                {%- endif -%}
                placeholder="Email"
                required
              >
            </div>

            {%- if form.password_needed -%}
              <div class="form__input-wrapper">
                <label for="CustomerPassword">Password</label>
                <input
                  type="password"
                  value=""
                  name="customer[password]"
                  id="CustomerPassword"
                  {% if form.errors contains 'form' %}
                    aria-invalid="true"
                    aria-describedby="LoginForm-error-password"
                  {%- endif -%}
                  placeholder="Password"
                  required
                >
              </div>
            {%- endif -%}

            <div class="form__input-wrapper">
              <button type="submit" class="button button--full-width">Log in</button>
            </div>

            <a href="#recover" class="form__link">Forgot your password?</a>

            <div class="form__input-wrapper">
              <h3>New customer?</h3>
              <p>Create an account with us to access your orders, manage subscriptions, and more.</p>
              <a href="{{ routes.account_register_url }}" class="button button--secondary button--full-width">Create account</a>
            </div>

            {%- if shop.checkout.guest_login -%}
              <div class="form__input-wrapper">
                <h3>Continue as guest</h3>
                <p>No account needed to checkout</p>
                <a href="{{ routes.root_url }}/checkout" class="button button--secondary button--full-width">Continue as guest</a>
              </div>
            {%- endif -%}
          {%- endform -%}
        </div>

        {%- if shop.checkout.guest_login -%}
          <div class="form-vertical">
            <hr class="hr--invisible">
            <h2>Continue as guest</h2>

            {%- form 'guest_login' -%}
              <button type="submit" class="button">Continue</button>
            {%- endform -%}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>

  <div id="RecoverPasswordForm" class="hide">
    <div class="page-width">
      <div class="grid">
        <div class="grid__item medium-up--one-half medium-up--push-one-quarter">
          <header class="customer__header">
            <h1 class="customer__title">Reset your password</h1>
            <p class="customer__subtext">
              We will send you an email to reset your password
            </p>
          </header>

          <div class="form-vertical">
            {%- form 'recover_customer_password' -%}
              {%- if form.errors -%}
                <div class="form-message form-message--error">
                  <h2 class="h3 form-message__title" tabindex="-1" data-form-status>
                    Please adjust the following:
                  </h2>
                  <ul class="form-message__list">
                    {%- for field in form.errors -%}
                      <li>
                        {%- if field == 'form' -%}
                          {{ form.errors.messages[field] }}
                        {%- else -%}
                          <a href="#RecoverForm-{{ field }}">
                            {{ form.errors.translated_fields[field] | capitalize }}
                            {{ form.errors.messages[field] }}
                          </a>
                        {%- endif -%}
                      </li>
                    {%- endfor -%}
                  </ul>
                </div>
              {%- endif -%}

              {%- if form.posted_successfully? -%}
                <div class="form-message form-message--success" tabindex="-1">
                  <h2 class="form-message__title" data-form-status>Success</h2>
                  <p>We've sent you an email with a link to update your password.</p>
                </div>
              {%- endif -%}

              <div class="form__input-wrapper">
                <label for="RecoverEmail">Email</label>
                <input
                  type="email"
                  value=""
                  name="email"
                  id="RecoverEmail"
                  autocorrect="off"
                  autocapitalize="off"
                  autocomplete="email"
                  {% if form.errors %}
                    aria-invalid="true"
                    aria-describedby="RecoverEmail-email-error"
                  {%- endif -%}
                  placeholder="Email"
                  required
                >
              </div>

              <div class="form__input-wrapper">
                <button type="submit" class="button">Submit</button>
              </div>

              <a href="#login" class="form__link">Cancel</a>
            {%- endform -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  {%- comment -%}
    This shows the password recovery form in a modal when the URL has #recover
  {%- endcomment -%}
  <div class="modal-overlay" id="RecoverModal">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Reset your password</h2>
        <button class="modal-close" onclick="closeRecoverModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>We will send you an email to reset your password</p>
        {%- form 'recover_customer_password' -%}
          <div class="form__input-wrapper">
            <label for="RecoverEmailModal">Email</label>
            <input
              type="email"
              name="email"
              id="RecoverEmailModal"
              autocorrect="off"
              autocapitalize="off"
              autocomplete="email"
              placeholder="Email"
              required
            >
          </div>
          <div class="form__input-wrapper">
            <button type="submit" class="button">Submit</button>
          </div>
        {%- endform -%}
        <button type="button" class="button button--secondary" onclick="closeRecoverModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Handle password recovery modal
  function closeRecoverModal() {
    document.getElementById('RecoverModal').classList.remove('active');
  }

  // Show recover modal when URL has #recover
  if (window.location.hash === '#recover') {
    document.getElementById('RecoverModal').classList.add('active');
  }

  // Handle form toggle
  document.addEventListener('DOMContentLoaded', function() {
    const recoverLinks = document.querySelectorAll('a[href="#recover"]');
    const loginLinks = document.querySelectorAll('a[href="#login"]');
    
    recoverLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('RecoverModal').classList.add('active');
      });
    });
    
    loginLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        closeRecoverModal();
      });
    });
  });
</script>

<style>
  .hide {
    display: none;
  }
  
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .modal-container {
    background-color: rgb(var(--color-background));
    border-radius: var(--media-radius);
    max-width: 400px;
    width: 90%;
    padding: 2rem;
    box-shadow: 0 1rem 3rem rgba(var(--color-shadow), 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .form__input-wrapper {
    margin-bottom: 1.5rem;
  }

  .form__input-wrapper label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .form__input-wrapper input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid rgba(var(--color-foreground), 0.2);
    border-radius: var(--inputs-radius);
    background-color: rgb(var(--color-background));
    color: rgb(var(--color-foreground));
  }

  .button {
    display: inline-block;
    padding: 0.75rem 2rem;
    background-color: rgb(var(--color-button));
    color: rgb(var(--color-button-text));
    border: none;
    border-radius: var(--buttons-radius);
    text-decoration: none;
    cursor: pointer;
    text-align: center;
    width: 100%;
  }

  .button--secondary {
    background-color: transparent;
    color: rgb(var(--color-foreground));
    border: 1px solid rgba(var(--color-foreground), 0.3);
  }

  .button--full-width {
    width: 100%;
  }

  .form__link {
    display: inline-block;
    margin-top: 1rem;
    color: rgb(var(--color-foreground));
    text-decoration: underline;
  }

  .form-message {
    padding: 1rem;
    border-radius: var(--inputs-radius);
    margin-bottom: 1.5rem;
  }

  .form-message--error {
    background-color: rgba(255, 0, 0, 0.1);
    border: 1px solid rgba(255, 0, 0, 0.3);
    color: rgb(var(--color-foreground));
  }

  .form-message--success {
    background-color: rgba(0, 255, 0, 0.1);
    border: 1px solid rgba(0, 255, 0, 0.3);
    color: rgb(var(--color-foreground));
  }

  .form-message__title {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
  }

  .form-message__list {
    margin: 0;
    padding-left: 1.5rem;
  }

  .hr--invisible {
    border: 0;
    margin: 2rem 0;
  }
</style>