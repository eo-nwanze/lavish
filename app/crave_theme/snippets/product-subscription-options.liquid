{%- comment -%}
  Subscription Options Display for Product Pages
  This snippet loads subscription options via JavaScript API calls
  instead of relying on Shopify's Liquid data
{%- endcomment -%}

<!-- Always show subscription options container - will be populated via JavaScript -->
<div class="product-subscription-options" 
     data-product-id="{{ product.id }}" 
     data-product-handle="{{ product.handle }}"
     data-variant-id="{{ product.selected_or_first_available_variant.id }}">
  <div class="subscription-loading">
    <div class="loading-spinner"></div>
    <p>Loading subscription options...</p>
  </div>
</div>

<style>
/* Product Subscription Options - Matching Orders Page Style */
.product-subscription-options {
  margin: 0 auto;
}

.subscription-loading {
  text-align: center;
  padding: 2rem;
  color: rgba(var(--color-foreground), 0.7);
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(var(--color-foreground), 0.1);
  border-top: 2px solid rgba(var(--color-button), var(--alpha-button-background));
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.subscription-header {
  margin-bottom: 2rem;
  text-align: center;
}

.subscription-header h3 {
  margin: 0 0 0.5rem 0;
  color: rgb(var(--color-foreground));
  font-size: 1.8rem;
  font-weight: 600;
}

.subscription-header p {
  margin: 0;
  color: rgba(var(--color-foreground), 0.7);
  font-size: 1.1rem;
}

.subscription-options-list {
  display: grid;
  gap: 1.5rem;
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
  overflow-x: hidden !important;
  overflow-y: visible !important;
  margin-bottom: 2rem;
}

.subscription-option {
  background-color: rgba(var(--color-foreground), 0.04);
  border-radius: var(--media-radius);
  padding: 1.5rem;
  border-left: 0.4rem solid transparent;
  transition: all 0.3s ease;
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
  overflow-x: hidden !important;
  overflow-y: visible !important;
  min-width: 0 !important;
  flex-shrink: 1 !important;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.subscription-option:hover {
  border-left-color: rgba(var(--color-button), var(--alpha-button-background));
  background-color: rgba(var(--color-foreground), 0.06);
}

.subscription-info {
  flex: 1;
  min-width: 0;
}

.subscription-info h4 {
  margin: 0 0 0.5rem 0;
  color: rgb(var(--color-foreground));
  font-size: 1.4rem;
  font-weight: 600;
}

.subscription-description {
  margin: 0 0 1rem 0;
  color: rgba(var(--color-foreground), 0.7);
  font-size: 1rem;
  line-height: 1.5;
}

.subscription-details {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.billing-interval,
.discount {
  padding: 0.3rem 0.8rem;
  border-radius: var(--buttons-radius);
  font-size: 1.1rem;
  font-weight: 500;
  display: inline-block;
}

.billing-interval {
  background-color: rgba(var(--color-button), 0.1);
  color: rgb(var(--color-button));
}

.discount {
  background-color: rgba(var(--color-success), 0.1);
  color: rgb(var(--color-success));
}

.subscription-action {
  flex-shrink: 0;
  margin-left: 1rem;
}

.subscribe-btn {
  background: rgba(var(--color-button), var(--alpha-button-background));
  color: rgb(var(--color-button-text));
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: var(--buttons-radius);
  font-size: 1.4rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-height: 4.4rem;
  white-space: nowrap;
}

.subscribe-btn:hover {
  background: rgba(var(--color-button), var(--alpha-button-background));
  opacity: 0.9;
  transform: translateY(-1px);
}

.subscribe-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
}

.subscription-benefits {
  background-color: rgba(var(--color-success), 0.05);
  border: 0.1rem solid rgba(var(--color-success), 0.2);
  border-radius: var(--media-radius);
  padding: 1.5rem;
}

.subscription-benefits h4 {
  margin: 0 0 1rem 0;
  color: rgb(var(--color-success));
  font-size: 1.4rem;
  font-weight: 600;
}

.subscription-benefits ul {
  margin: 0;
  padding: 0;
  list-style: none;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.5rem;
}

.subscription-benefits li {
  color: rgba(var(--color-foreground), 0.8);
  font-size: 1rem;
  position: relative;
  padding-left: 1.5rem;
}

.subscription-benefits li::before {
  content: "✓";
  position: absolute;
  left: 0;
  color: rgb(var(--color-success));
  font-weight: bold;
}

/* Error and success states */
.subscription-error,
.subscription-checkout-error {
  background-color: rgba(var(--color-error), 0.05);
  border: 0.1rem solid rgba(var(--color-error), 0.2);
  border-radius: var(--media-radius);
  padding: 1.5rem;
  text-align: center;
  color: rgb(var(--color-error));
}

.subscription-success {
  background-color: rgba(var(--color-success), 0.05);
  border: 0.1rem solid rgba(var(--color-success), 0.2);
  border-radius: var(--media-radius);
  padding: 1.5rem;
  text-align: center;
}

.subscription-success h4 {
  color: rgb(var(--color-success));
  margin: 0 0 1rem 0;
}

.subscription-details {
  margin: 1rem 0;
  text-align: left;
}

.subscription-details p {
  margin: 0.5rem 0;
  color: rgba(var(--color-foreground), 0.8);
}

.subscription-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1.5rem;
}

.manage-subscription-btn,
.continue-shopping-btn,
.retry-btn {
  padding: 0.8rem 1.5rem;
  border-radius: var(--buttons-radius);
  font-size: 1.4rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-height: 4.4rem;
  white-space: nowrap;
  border: none;
}

.manage-subscription-btn {
  background: rgba(var(--color-button), var(--alpha-button-background));
  color: rgb(var(--color-button-text));
}

.continue-shopping-btn,
.retry-btn {
  background: transparent;
  color: rgb(var(--color-foreground));
  border: 0.1rem solid rgba(var(--color-foreground), 0.2);
}

.retry-btn {
  background: rgba(var(--color-error), 0.1);
  color: rgb(var(--color-error));
  border-color: rgba(var(--color-error), 0.2);
}

/* Mobile responsive - matching orders page */
@media screen and (max-width: 768px) {
  .subscription-option {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
    padding: 1.5rem;
  }

  .subscription-action {
    margin-left: 0;
    width: 100%;
  }

  .subscribe-btn {
    width: 100%;
    max-width: 300px;
  }

  .subscription-details {
    justify-content: center;
  }

  .subscription-benefits ul {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
// Load subscription options when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Load subscription options via API
  const container = document.querySelector('.product-subscription-options');
  const productId = container.dataset.productId;
  const productHandle = container.dataset.productHandle;
  
  if (container && productId) {
    // Try multiple API endpoints for reliability
    const apiEndpoints = [
      'http://127.0.0.1:8003/api/subscriptions/selling-plans/?product_id=' + productId,
      'http://localhost:8003/api/subscriptions/selling-plans/?product_id=' + productId,
      '/api/subscriptions/selling-plans/?product_id=' + productId
    ];
    
    // Try each endpoint until one works
    let endpointIndex = 0;
    
    function tryNextEndpoint() {
      if (endpointIndex >= apiEndpoints.length) {
        // All endpoints failed, show error
        showSubscriptionError(container, 'Unable to load subscription options. Please refresh the page.');
        return;
      }
      
      const endpoint = apiEndpoints[endpointIndex];
      
      fetch(endpoint)
        .then(response => {
          console.log('[Subscription Plans] API Response Status:', response.status);
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          console.log('[Subscription Plans] API Response Data:', data);
          console.log('[Subscription Plans] Has selling_plans?', !!data.selling_plans);
          console.log('[Subscription Plans] Plans count:', data.selling_plans ? data.selling_plans.length : 0);
          
          // Log first plan details if available
          if (data.selling_plans && data.selling_plans.length > 0) {
            console.log('[Subscription Plans] First plan sample:', {
              name: data.selling_plans[0].name,
              type: data.selling_plans[0].price_adjustment_type,
              value: data.selling_plans[0].price_adjustment_value
            });
          }
          
          // Check if we have selling plans data
          // API returns: { product_id, product_name, selling_plans: [...] }
          if (data.selling_plans && data.selling_plans.length > 0) {
            console.log('[Subscription Plans] Rendering', data.selling_plans.length, 'plans');
            // Render subscription options
            renderSubscriptionOptions(container, data.selling_plans, productId, productHandle);
          } else if (data.error) {
            console.error('[Subscription Plans] API Error:', data.error);
            // API returned an error
            showSubscriptionError(container, data.error);
          } else {
            console.warn('[Subscription Plans] No plans available, hiding container');
            // No plans available, hide container
            container.style.display = 'none';
          }
        })
        .catch(error => {
          console.warn('Failed to load from ' + endpoint + ':', error);
          endpointIndex++;
          tryNextEndpoint();
        });
    }
    
    // Start trying endpoints
    tryNextEndpoint();
    
    // Set a timeout to prevent infinite loading
    setTimeout(function() {
      if (container.querySelector('.subscription-loading')) {
        showSubscriptionError(container, 'Loading subscription options is taking longer than expected. Please refresh the page.');
      }
    }, 10000);
  }
});

function showSubscriptionError(container, message) {
  container.innerHTML = '<div class="subscription-error"><p>' + message + '</p><button class="retry-btn" onclick="location.reload()">Retry</button></div>';
}

function renderSubscriptionOptions(container, plans, productId, productHandle) {
  console.log('[Render Plans] Starting render with', plans.length, 'plans');
  console.log('[Render Plans] All plans data:', plans);
  
  var optionsHTML = plans.map(function(plan) {
    console.log('[Render Plan] Processing:', plan.name);
    console.log('[Render Plan] Price adjustment type:', plan.price_adjustment_type);
    console.log('[Render Plan] Price adjustment value:', plan.price_adjustment_value);
    console.log('[Render Plan] Value type:', typeof plan.price_adjustment_value);
    
    // Format interval text
    var intervalText = plan.billing_interval_count + ' ' + plan.billing_interval.toLowerCase();
    if (plan.billing_interval_count == 1) {
      // Remove 's' for singular (1 month, not 1 months)
      intervalText = plan.billing_interval.toLowerCase();
      if (intervalText === 'month') intervalText = 'month';
      if (intervalText === 'week') intervalText = 'week';
      if (intervalText === 'day') intervalText = 'day';
      if (intervalText === 'year') intervalText = 'year';
    } else {
      // Add 's' for plural (2 months, 3 months, etc.)
      intervalText = plan.billing_interval_count + ' ' + plan.billing_interval.toLowerCase() + 's';
    }
    
    // Format discount text
    var discountText = '';
    console.log('[Render Plan] Checking discount - Type:', plan.price_adjustment_type, 'Value:', plan.price_adjustment_value, 'Value > 0?', plan.price_adjustment_value > 0);
    
    if (plan.price_adjustment_type === 'PERCENTAGE' && plan.price_adjustment_value > 0) {
      discountText = 'Save ' + plan.price_adjustment_value + '%';
      console.log('[Render Plan] PERCENTAGE discount text:', discountText);
    } else if (plan.price_adjustment_type === 'FIXED_AMOUNT' && plan.price_adjustment_value > 0) {
      discountText = 'Save $' + plan.price_adjustment_value;
      console.log('[Render Plan] FIXED_AMOUNT discount text:', discountText);
    } else if (plan.price_adjustment_type === 'PRICE') {
      discountText = '$' + plan.price_adjustment_value + ' per delivery';
      console.log('[Render Plan] PRICE discount text:', discountText);
    } else {
      console.warn('[Render Plan] NO DISCOUNT TEXT GENERATED!', {
        type: plan.price_adjustment_type,
        value: plan.price_adjustment_value,
        typeMatch: plan.price_adjustment_type === 'PERCENTAGE',
        valueCheck: plan.price_adjustment_value > 0
      });
    }
    
    console.log('[Render Plan] Final discount text:', discountText || '(none)');
    
    return '<div class="subscription-option">' +
      '<div class="subscription-info">' +
        '<h4>' + plan.name + '</h4>' +
        '<p class="subscription-description">' + (plan.description || '') + '</p>' +
        '<div class="subscription-details">' +
          '<span class="billing-interval">Every ' + intervalText + '</span>' +
          (discountText ? '<span class="discount">' + discountText + '</span>' : '<span class="discount">DEBUG: No discount</span>') +
        '</div>' +
      '</div>' +
      '<div class="subscription-action">' +
        '<button class="subscribe-btn btn-primary" ' +
                'data-plan-id="' + plan.id + '" ' +
                'data-plan-name="' + plan.name + '" ' +
                'data-product-id="' + productId + '" ' +
                'data-product-handle="' + productHandle + '">' +
          'Subscribe' +
        '</button>' +
      '</div>' +
    '</div>';
  }).join('');
  
  console.log('[Render Plans] Generated HTML length:', optionsHTML.length);
  console.log('[Render Plans] HTML preview:', optionsHTML.substring(0, 200));
  
  container.innerHTML = 
    '<div class="subscription-header">' +
      '<h3>Subscribe & Save</h3>' +
      '<p>Choose a subscription plan and save on every order!</p>' +
    '</div>' +
    '<div class="subscription-options-list">' +
      optionsHTML +
    '</div>' +
    '<div class="subscription-benefits">' +
      '<h4>Subscription Benefits:</h4>' +
      '<ul>' +
        '<li>✓ Save on every order</li>' +
        '<li>✓ Never run out of your favorite items</li>' +
        '<li>✓ Exclusive subscriber perks</li>' +
        '<li>✓ Easy to skip or cancel anytime</li>' +
      '</ul>' +
    '</div>';
  
  // Initialize subscription checkout functionality
  initializeSubscriptionButtons(container);
}

function initializeSubscriptionButtons(container) {
  // Add click handlers for subscribe buttons
  container.querySelectorAll('.subscribe-btn').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      var planId = this.dataset.planId;
      var planName = this.dataset.planName;
      var productId = this.dataset.productId;
      var productHandle = this.dataset.productHandle;
      
      // Show loading state
      var originalText = this.textContent;
      this.textContent = 'Subscribing...';
      this.disabled = true;
      
      // Create subscription checkout
      createSubscriptionCheckout(planId, planName, productId, productHandle, this);
    });
  });
}

function createSubscriptionCheckout(planId, planName, productId, productHandle, button) {
  // Get variant ID from container
  var container = button.closest('.product-subscription-options');
  var variantId = container.dataset.variantId;
  
  console.log('[Subscription Checkout] Starting checkout process', {
    planId: planId,
    planName: planName,
    productId: productId,
    variantId: variantId
  });
  
  if (!variantId) {
    console.error('[Subscription Checkout] No variant ID found');
    showCheckoutError(button, 'Product variant not found. Please refresh the page.');
    return;
  }
  
  // Try multiple checkout endpoints
  var checkoutEndpoints = [
    'http://127.0.0.1:8003/api/subscriptions/checkout/create/',
    'http://localhost:8003/api/subscriptions/checkout/create/',
    '/api/subscriptions/checkout/create/'
  ];
  
  var endpointIndex = 0;
  
  function tryNextCheckoutEndpoint() {
    if (endpointIndex >= checkoutEndpoints.length) {
      // All endpoints failed
      console.error('[Subscription Checkout] All API endpoints failed');
      showCheckoutError(button, 'Unable to process subscription. Please try again.');
      return;
    }
    
    var endpoint = checkoutEndpoints[endpointIndex];
    console.log('[Subscription Checkout] Trying endpoint:', endpoint);
    
    fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        selling_plan_id: planId,
        variant_id: variantId,
        product_id: productId,
        quantity: 1
      })
    })
    .then(function(response) {
      console.log('[Subscription Checkout] API response status:', response.status);
      if (!response.ok) {
        throw new Error('HTTP ' + response.status);
      }
      return response.json();
    })
    .then(function(data) {
      console.log('[Subscription Checkout] API response data:', data);
      
      if (data.success && data.checkout_method === 'native') {
        // Use Shopify native checkout with cart
        console.log('[Subscription Checkout] Using native checkout method');
        addToCartAndCheckout(data.cart_data, planName, button);
      } else if (data.success) {
        // Legacy success response
        console.log('[Subscription Checkout] Using legacy success handler');
        showCheckoutSuccess(button, planName, data);
      } else {
        throw new Error(data.error || 'Checkout failed');
      }
    })
    .catch(function(error) {
      console.warn('[Subscription Checkout] Failed on ' + endpoint + ':', error);
      endpointIndex++;
      tryNextCheckoutEndpoint();
    });
  }
  
  tryNextCheckoutEndpoint();
}

function addToCartAndCheckout(cartData, planName, button) {
  console.log('[Cart API] Adding item to cart with data:', cartData);
  
  // Add item to cart with subscription using Shopify Cart API
  fetch('/cart/add.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      id: cartData.variant_id,
      quantity: cartData.quantity,
      selling_plan: cartData.selling_plan
    })
  })
  .then(function(response) {
    console.log('[Cart API] Response status:', response.status);
    
    if (!response.ok) {
      return response.text().then(function(text) {
        console.error('[Cart API] Error response:', text);
        throw new Error('Failed to add to cart: ' + response.status);
      });
    }
    return response.json();
  })
  .then(function(item) {
    console.log('[Cart API] Item added successfully:', item);
    
    // Check if we're in local development (port 9292 or localhost dev)
    var isLocalDev = window.location.port === '9292' || 
                     window.location.hostname === '127.0.0.1' || 
                     window.location.hostname === 'localhost';
    
    console.log('[Cart API] Environment check - isLocalDev:', isLocalDev);
    
    if (isLocalDev) {
      // In development: Show success message with manual checkout link
      console.log('[Cart API] Showing cart success message (local dev mode)');
      showCartSuccessMessage(button, planName, item);
    } else {
      // In production: Redirect to checkout
      console.log('[Cart API] Redirecting to checkout (production mode)');
      button.textContent = 'Redirecting to checkout...';
      setTimeout(function() {
        var checkoutUrl = window.Shopify && window.Shopify.routes && window.Shopify.routes.root 
          ? window.Shopify.routes.root + 'checkout' 
          : '/checkout';
        console.log('[Cart API] Redirecting to:', checkoutUrl);
        window.location.href = checkoutUrl;
      }, 500);
    }
  })
  .catch(function(error) {
    console.error('[Cart API] Error:', error);
    showCheckoutError(button, 'Unable to add subscription to cart. Please try again.');
  });
}

function showCartSuccessMessage(button, planName, cartItem) {
  // Show success message with cart/checkout options
  var container = button.closest('.product-subscription-options');
  var successHTML = 
    '<div class="subscription-success">' +
      '<h4 style="color: #008060; margin: 0 0 1rem 0;">✓ Subscription Added to Cart!</h4>' +
      '<p style="margin: 0 0 1.5rem 0;">Subscription <strong>' + planName + '</strong> has been added to your cart.</p>' +
      '<div class="subscription-details" style="background: rgba(0,128,96,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">' +
        '<p style="margin: 0.5rem 0;"><strong>Variant ID:</strong> ' + (cartItem.variant_id || cartItem.id) + '</p>' +
        '<p style="margin: 0.5rem 0;"><strong>Quantity:</strong> ' + (cartItem.quantity || 1) + '</p>' +
        '<p style="margin: 0.5rem 0;"><strong>Selling Plan:</strong> ' + (cartItem.selling_plan_allocation ? cartItem.selling_plan_allocation.selling_plan.id : 'Included') + '</p>' +
      '</div>' +
      '<div class="subscription-actions" style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">' +
        '<a href="/cart" class="button button--primary" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; text-decoration: none;">' +
          'View Cart' +
        '</a>' +
        '<button class="button" onclick="location.reload()" style="flex: 1; min-width: 150px;">' +
          'Continue Shopping' +
        '</button>' +
      '</div>' +
      '<p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">' +
        '<strong>Note:</strong> To complete your subscription purchase, go to your cart and proceed to checkout.' +
      '</p>' +
    '</div>';
  
  container.innerHTML = successHTML;
}

function showCheckoutSuccess(button, planName, data) {
  var container = button.closest('.product-subscription-options');
  var successHTML = 
    '<div class="subscription-success">' +
      '<h4 style="color: #008060; margin: 0 0 1rem 0;">✓ Subscription Added to Cart!</h4>' +
      '<p style="margin: 0 0 1.5rem 0;">Subscription <strong>' + planName + '</strong> has been added to your cart.</p>' +
      '<div class="subscription-actions" style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">' +
        '<a href="/cart" class="button button--primary" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; text-decoration: none;">' +
          'View Cart' +
        '</a>' +
        '<button class="button" onclick="location.reload()" style="flex: 1; min-width: 150px;">' +
          'Continue Shopping' +
        '</button>' +
      '</div>' +
      '<p style="margin-top: 1rem; font-size: 0.9rem; color: #666; text-align: center;">' +
        'Complete your purchase by going to your cart and checking out.' +
      '</p>' +
    '</div>';
  
  container.innerHTML = successHTML;
}

function showCheckoutError(button, message) {
  // Restore button state
  button.disabled = false;
  button.textContent = 'Subscribe';
  
  // Show error message
  var errorDiv = document.createElement('div');
  errorDiv.className = 'subscription-checkout-error';
  errorDiv.innerHTML = '<p>' + message + '</p><button class="retry-btn" onclick="location.reload()">Try Again</button>';
  
  button.parentNode.appendChild(errorDiv);
  
  // Remove error after 5 seconds
  setTimeout(function() {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 5000);
}
</script>